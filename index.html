<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BookBunny 📚🐰</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<button id="logoutBtn" class="logout">Logout</button>
<button id="themeToggle" class="theme-btn">🌙</button>

<div class="container">
  <h1 id="welcomeTitle">Hi Reader 🐰</h1>
  <p>Your cozy corner for book lovers 💕</p>

  <!-- ✅ Search Bar -->
  <input type="text" id="searchInput" placeholder="Search for any book…">
  <button id="searchBtn" class="main-btn">Search 🔍</button>
  <ul id="searchResults"></ul>

  <hr class="divider">

  <!-- ✅ Recommendations -->
  <button id="loadBooks" class="main-btn">Show Recommended Books ✨</button>
  <ul id="bookList"></ul>
</div>

<!-- ✅ Review Modal -->
<div id="reviewModal" class="modal">
  <div class="modal-content">
    <h3>Write a Review ✍</h3>
    <textarea id="reviewText" placeholder="Share your thoughts…" maxlength="300"></textarea>
    <br>
    <button id="saveReviewBtn" class="main-btn">Save Review ✅</button>
    <button id="closeModalBtn" class="reviewBtn">Cancel</button>
  </div>
</div>

<script>
console.log("✅ Home script loaded");
const apiUrl = "https://bookbunny-backend.onrender.com";

/* ✅ Username Greeting */
const user = localStorage.getItem("username");
if (!user) {
  window.location.href = "login.html";
} else {
  document.getElementById("welcomeTitle").textContent = `Hi ${user} 🐰`;
}

/* ✅ Logout */
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem("username");
  window.location.href = "login.html";
});

/* ✅ Theme Toggle */
const btnTheme = document.getElementById("themeToggle");
if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
  btnTheme.textContent = "☀️";
}
btnTheme.addEventListener("click",()=>{
  const dark=document.body.classList.toggle("dark");
  btnTheme.textContent = dark ? "☀️" : "🌙";
  localStorage.setItem("theme", dark ? "dark" : "light");
});

/* ✅ Recommendations */
document.getElementById("loadBooks").addEventListener("click", async () => {
  const res = await fetch(`${apiUrl}/books`);
  const books = await res.json();
  const list = document.getElementById("bookList");
  list.innerHTML = "";
  books.forEach(book => {
    list.innerHTML += `
      <li class="book-card">
        <h3>${book.title}</h3>
        <p><strong>Author:</strong> ${book.author}</p>
        <p><strong>Genre:</strong> ${book.genre}</p>
      </li>
    `;
  });
});

/* ✅ GLOBAL SEARCH + Reviews + Favorites + Goodreads */
let activeBookCard = null;

document.getElementById("searchBtn").addEventListener("click", async () => {
  const query = document.getElementById("searchInput").value.trim();
  if (!query) return;

  const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}`);
  const data = await res.json();

  const list = document.getElementById("searchResults");
  list.innerHTML = "";

  if (!data.items) {
    list.innerHTML = "<p>No results found 😢</p>";
    return;
  }

  data.items.forEach((book, index) => {
    const info = book.volumeInfo;
    const goodreadsQuery = encodeURIComponent(info.title + " " + (info.authors?.[0] || ""));
    const itemId = `book-${index}`;
    
    list.innerHTML += `
      <li class="book-card" id="${itemId}">
        <img src="${info.imageLinks?.thumbnail || ''}" class="book-img">
        <h3>${info.title}</h3>
        <p><strong>Author:</strong> ${info.authors?.join(", ") || "Unknown"}</p>
        <p><strong>Published:</strong> ${info.publishedDate || "N/A"}</p>
        <p><strong>Pages:</strong> ${info.pageCount || "N/A"}</p>

        <label><strong>Your Rating:</strong></label>
        <input type="number" min="0" max="5" step="0.25" class="ratingInput" placeholder="0–5"> ⭐

        <button class="favBtn">❤️ Add to Favorites</button>
        <button class="reviewBtn" onclick="openReviewModal('${itemId}')">✍ Add Review</button>

        <a href="https://www.goodreads.com/search?q=${goodreadsQuery}" target="_blank" class="goodreads-btn">
          View on Goodreads 🔗
        </a>

        <div class="reviews"></div>
      </li>
    `;
  });
});

/* ✅ Review Modal Logic */
function openReviewModal(bookCardId) {
  activeBookCard = document.getElementById(bookCardId);
  document.getElementById("reviewModal").style.display = "flex";
}

document.getElementById("saveReviewBtn").addEventListener("click", () => {
  const text = document.getElementById("reviewText").value.trim();
  if (!text) return;

  activeBookCard.querySelector(".reviews").innerHTML += `<p>📝 ${text}</p>`;
  
  document.getElementById("reviewText").value = "";
  document.getElementById("reviewModal").style.display = "none";
});

document.getElementById("closeModalBtn").addEventListener("click", () => {
  document.getElementById("reviewModal").style.display = "none";
});
</script>

</body>
</html>
